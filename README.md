# Плагин Multicat для Cotonti Siena

![Cotonti Siena](https://img.shields.io/badge/Cotonti-Siena%20v0.9.26-blue) ![PHP](https://img.shields.io/badge/PHP-8.4%2B-green) ![MySQL](https://img.shields.io/badge/MySQL-8.0%2B-yellow) ![License](https://img.shields.io/badge/License-BSD-red) ![Version](https://img.shields.io/badge/Version-1.1.0-orange)

## Описание плагина

Плагин **Multicat** предназначен для модуля **Page** в CMF Cotonti Siena. Он позволяет назначать страницы сразу в несколько категорий, расширяя стандартные возможности системы, где страница может принадлежать только одной категории. Это полезно для сайтов с сложной структурой контента, где материалы могут относиться к нескольким темам одновременно.

- **Ключевые особенности**:
  - Хранение связей категорий в отдельной таблице `cot_page_multicats` с использованием `structure_id` для идентификации категорий.
  - Автоматическая миграция существующих категорий при установке.
  - Интеграция с формами добавления/редактирования страниц через чекбоксы.
  - Отображение множественных категорий в админ-панели и списках страниц.
  - Поддержка фильтрации страниц по категориям в списках, учитывая мультикатегории.

Плагин разработан для Cotonti Siena версии 0.9.26 и выше, с поддержкой PHP 8.4+ и MySQL 8.0+. Он не требует дополнительных библиотек и использует встроенные механизмы Cotonti (хуки, структура, SQL-запросы).

- **Автор**: webitproff
- **Дата выпуска**: 2025-09-14
- **Версия**: 1.1.0
- **Лицензия**: BSD
- **Репозиторий**: [https://github.com/webitproff](https://github.com/webitproff)
- **Зависимости**: Модуль `page` (требуется), другие модули не обязательны.

## Принципы работы

Плагин работает на основе хуков Cotonti, расширяя функциональность модуля Page без изменения核心 кода системы. Основные принципы:

1. **Хранение данных**:
   - Используется таблица `cot_page_multicats` для хранения связей между страницами (`pcat_page_id`) и категориями (`pcat_cat_id`), где `pcat_cat_id` — это `structure_id` из таблицы `cot_structure`.
   - Это позволяет избежать дублирования данных и сохранять совместимость со стандартным модулем Page.
   - При установке автоматически мигрируются существующие категории из `cot_pages` (поле `page_cat` преобразуется в `structure_id`).

2. **Обработка категорий**:
   - Функции в `inc/multicat.functions.php` позволяют получать, сохранять и отображать категории.
   - Категории выбираются через чекбоксы в формах добавления/редактирования страниц.
   - Первая выбранная категория устанавливается как основная (`page_cat` в `cot_pages`), остальные — в мультикатегориях.
   - В списках страниц (page.list) фильтр по категории учитывает как основную, так и дополнительные категории через подзапросы SQL.

3. **Интеграция с UI**:
   - Добавляются теги в шаблоны: `{PAGEFORM_CAT}` для чекбоксов и `{PAGEFORM_CAT_HINT}` для подсказки.
   - В админ-панели отображается список категорий для каждой страницы.
   - Языковой файл поддерживает русский язык, с возможностью добавления других.

4. **Безопасность и производительность**:
   - Все запросы используют подготовленные параметры для защиты от SQL-инъекций.
   - Фильтрация по категориям оптимизирована с использованием индексов таблицы.
   - Проверка прав доступа (`cot_auth`) при отображении категорий в формах.

Плагин не влияет на производительность для сайтов с небольшим количеством страниц, но для крупных сайтов рекомендуется индексация таблицы `cot_page_multicats`.

## Интеграция

Плагин интегрируется через стандартные хуки Cotonti. Нет необходимости модифицировать核心 файлы — все изменения происходят через плагинные файлы.

- **Хуки, используемые в плагине**:
  - `global`: Определение таблицы и загрузка языка.
  - `page.add.add.done`: Сохранение категорий после добавления страницы.
  - `page.admin.loop`: Отображение категорий в админ-списке.
  - `page.delete.first`: Удаление связей перед удалением страницы.
  - `page.edit.update.import`: Импорт и валидация категорий при редактировании.
  - `page.edit.tags`: Генерация формы чекбоксов в редакторе.
  - `page.edit.update.done`: Сохранение категорий после обновления.
  - `page.list.query`: Фильтрация списка страниц по категории.

- **Изменения в шаблонах**:
  - В файлы `page.edit.tpl` и `page.add.tpl` добавьте `{PAGEFORM_CAT}` и `{PAGEFORM_CAT_HINT}` сразу после стандартного поля категории.

- **Совместимость**:
- Работает с модулем Page без конфликтов.
- Если используются другие плагины на категории (например, для SEO), протестируйте на совместимость.

## Инструкции по установке и использованию

### Установка

1. **Скачайте плагин**:
- Клонируйте репозиторий: `git clone https://github.com/webitproff/multicat.git` или скачайте ZIP.

2. **Установка через админ-панель Cotonti**:
- Скопируйте папку `multicat` в `plugins/` вашего сайта.
- В админ-панели перейдите в "Расширения" > "Установка" и установите плагин `multicat`.
- При установке автоматически создастся таблица `cot_page_multicats` и мигрируются существующие категории.

3. **Настройка**:
- В конфигурации плагина (`Админ > Расширения > Multicat > Конфигурация`) включите опцию `enabled` (по умолчанию включена).

### Использование

1. **Добавление/редактирование страницы**:
- В форме страницы выберите несколько категорий через чекбоксы.
- Обязательно выберите хотя бы одну — иначе ошибка.
- Сохраните: категории сохранятся в БД.

2. **Просмотр**:
- В админ-списке страниц увидите все категории через запятую.
- В списках страниц (на сайте) фильтр по категории покажет страницы из мультикатегорий.

3. **Удаление**:
- При удалении страницы связи автоматически удаляются.

4. **Обновление/удаление плагина**:
- Перед удалением: Сделайте бэкап БД.
- Удалите через админ-панель — таблица не удаляется автоматически (удалите вручную, если нужно).

### Возможные проблемы и решения

- **Ошибка "необходимо выбрать хотя бы одну категорию"**: Убедитесь, что выбрана категория в форме.
- **Категории не отображаются**: Проверьте права доступа (`cot_auth`) и наличие `structure_id` в БД.
- **Конфликты с шаблонами**: Убедитесь, что добавлены теги `{PAGEFORM_CAT}` и `{PAGEFORM_CAT_HINT}`.
- **Миграция не сработала**: Проверьте SQL-запрос в `setup/multicat.install.sql` и выполните вручную.


